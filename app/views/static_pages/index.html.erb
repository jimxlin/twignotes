<nav class="col-sm-3 col-md-2 bg-faded sidebar collapse" id="sidebar">
  <ul class="nav flex-column edit-notes">
    <li class="nav-item">
      <div class="create-note">
        New Note +
      </div>
    </li>
    <li class="nav-item clear-selected-tags">
      clear selected
    </li>
  </ul>

  <ul class="nav flex-column list-hashtags">

  </ul>

  <ul class="nav flex-column list-mentions">

  </ul>

  <ul class="nav flex-column list-untagged">
    <li class="nav-item view-untagged-">
      Untagged
    </li>
  </ul>
</nav>

<main class="col-12">
  <div class="filter-bar row">
    <ul class="tag-filters">

    </ul>
    <div class="time-filters col-sm-4 col-md-3 col-lg-2">
      <p>time filters here</p>
    </div>
  </div>
  <div class="notecards-container row">

  </div>
</main>


<script>
  $(function() {

    // key: tag_id, value: array of associated note_ids
    var tagNoteIds = {};
    $.get("/taggings").success(function(taggings) {
      taggings.forEach(function(tagging, i) {
        if (tagNoteIds[tagging.tag_id]) {
          tagNoteIds[tagging.tag_id].push(tagging.note_id);
        } else {
          tagNoteIds[tagging.tag_id] = [tagging.note_id];
        }
      });
    });

    // populate sidebar with tags
    $.get("/tags").success(function(tags) {
      if (!tags) return null;
      var hashtagHtml = "";
      var mentionHtml = "";
      tags.forEach(function(tag, i) {
        if (tag.mention) {
          mentionHtml += sidebarTagHtml(tag, true);
        } else {
          hashtagHtml += sidebarTagHtml(tag, false);
        }
      });
      $('.list-hashtags').append(hashtagHtml);
      $('.list-mentions').append(mentionHtml);
    });

    // Populate main window with notes
    populateNotes();

    // Filter notes by tags in sidebar
    var filterTagIds = [];
    $('.sidebar').on('click','.view',function(){
      var $checkbox = $(this).children('input');
      var tagId = $checkbox.data('id');
      var tagName = $(this).children('label').text();

      // Remove tag filter
      if ($checkbox.prop('checked')) {
        $checkbox.prop('checked', false);
        filterTagIds.splice(filterTagIds.indexOf(tagId), 1);
        $('.tag-filters #' + tagId).remove();

      // Add tag filter
      } else {
        $checkbox.prop('checked', true);
        filterTagIds.push(tagId);
        $('.tag-filters').append(filterBarHtml(tagName, tagId));
      }
      populateNotes();
    });

    // Remove tag filters when clicking them on the filter-bar
    $('.tag-filters').on('click', 'li', function(){
      var tagId = $(this).attr('id');

      $('[data-id=' + tagId + ']').prop('checked', false);
      filterTagIds.splice(filterTagIds.indexOf(tagId), 1);
      $(this).remove();

      populateNotes();
    });

/******************************************************************************/

    function populateNotes() {
      $('.note-container').remove();
      $.get("/notes").success(function(notes) {
        if (!notes) return null;
        var notesHtml = "";
        filterNotesByTag(notes).forEach(function(note, i) {
          notesHtml += noteHtml(note);
        });
        $('.notecards-container').append(notesHtml);
      });
    }

    // Creates an <li> tag element for the filter-bar
    function filterBarHtml(tagName, tagId) {
      var tagHtml = '<li id="' + tagId + '">' + tagName + '</li>';
      return tagHtml;
    }

    // Creates an <li> element out of JSON data for tags
    function sidebarTagHtml(tag, mention) {
      var prefix = mention ? '@' : '#';
      var noteCount = tagNoteIds[tag.id].length
      var labelStr = prefix + tag.name + ' (' + noteCount + ')'
      var liElement =
        '<li><div class="view">' +
        '<label>' + labelStr + '</label>' +
        '<input class="toggle" type="checkbox" data-id="' + tag.id + '">' +
        '</div></li>';
      return liElement;
    }

    // Creates an <div> element out of JSON data for Notes
    function noteHtml(note) {
      var titleHtml = note.title ? '<p>' + note.title + '</p><hr />' : '';
      var divElement =
        '<div class="col-xs-12 col-sm-6 col-md-4 col-lg-3 col-xl-2 note-container">' +
        '<div class="notecard">' +
        titleHtml +
        '<p>' + note.body + '</p>' +
        '</div></div>';
      return divElement;
    }

    // Filters JSON note objects by tagNoteIds
    function filterNotesByTag(notes) {
      if (filterTagIds.length === 0) return notes;

      var tagFilteredNoteIds = [];
      filterTagIds.forEach(function(tagId, i) {
        tagFilteredNoteIds = tagFilteredNoteIds.concat(tagNoteIds[tagId]);
      });

      var filteredNotes = [];
      notes.forEach(function(note, i){
        if (tagFilteredNoteIds.includes(note.id)) {
          filteredNotes.push(note);
        }
      });
      return filteredNotes;
    }
  });
</script>
